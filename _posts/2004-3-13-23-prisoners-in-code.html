--- 
title: 23 Prisoners, in code
mt_id: 38
layout: post
date: 2004-03-13 11:12:54 +00:00
---
And here is a C program that tests my solution. 
<code><pre>#include &lt;stdlib.h&gt;<br>#include &lt;stdio.h&gt;<br><br>#define PRISONERS_COUNT (23)<br>#define STRAGGLER_FACTOR (4)<br><br>enum {<br>  MANAGER_SYNC,<br>  MANAGER_RESYNC,<br>  MANAGER_COUNT,<br>  PRISONER_UNKNOWN,<br>  PRISONER_UNKNOWN_SAW_ON,<br>  PRISONER_UNKNOWN_SAW_OFF,<br>  PRISONER_READY,<br>  PRISONER_IDLE<br>};<br><br>enum {<br>  ACTION_UNDECIDED,<br>  ACTION_FLIP_A,<br>  ACTION_FLIP_B,<br>  ACTION_CALL_WARDEN<br>};<br><br>int switch_a, switch_b;<br>int prisoner_visited[PRISONERS_COUNT];<br>int prisoner_state[PRISONERS_COUNT];<br>int manager_count;<br>int manager_straggler_count;<br>int stats_visits;<br><br>static int call_warden(void) {<br>  int i = PRISONERS_COUNT;<br>  while (i--) {<br>    if (0 == prisoner_visited[i]) {<br>      return 1; // execute<br>    }<br>  }<br>  return 0; // set free<br>}<br><br>static int visit_room(int prisoner) {<br>  int action = ACTION_UNDECIDED;<br><br>  prisoner_visited[prisoner]++;<br><br>  switch (prisoner_state[prisoner]) {<br>  case MANAGER_SYNC:<br>    action = ACTION_FLIP_A;<br>    if (switch_a) {<br>      prisoner_state[prisoner] = MANAGER_COUNT;<br>    }<br>    break;<br>  case MANAGER_RESYNC:<br>    if (switch_a) {<br>      if (++manager_count == PRISONERS_COUNT) {<br>        action = ACTION_CALL_WARDEN;<br>      } else {<br>        action = ACTION_FLIP_A;<br>      }<br>    } else {<br>      action = ACTION_FLIP_A;<br>      prisoner_state[prisoner] = MANAGER_SYNC;<br>    }<br>    break;<br>  case MANAGER_COUNT:<br>    if (switch_a) {<br>      if (++manager_count == PRISONERS_COUNT) {<br>        action = ACTION_CALL_WARDEN;<br>      } else {<br>        action = ACTION_FLIP_A;<br>      }<br>    } else {<br>      action = ACTION_FLIP_B;<br>      if (++manager_straggler_count &gt; STRAGGLER_FACTOR) {<br>        manager_straggler_count = 0;<br>        prisoner_state[prisoner] = MANAGER_RESYNC;<br>      }<br>    }<br>    break;<br>  case PRISONER_UNKNOWN:<br>    action = ACTION_FLIP_B;<br>    if (switch_a) {<br>      prisoner_state[prisoner] = PRISONER_UNKNOWN_SAW_ON;<br>    } else {<br>      prisoner_state[prisoner] = PRISONER_UNKNOWN_SAW_OFF;<br>    }<br>    break;<br>  case PRISONER_UNKNOWN_SAW_ON:<br>    action = ACTION_FLIP_B;<br>    if (!switch_a) {<br>      prisoner_state[prisoner] = PRISONER_READY;<br>    }<br>    break;<br>  case PRISONER_UNKNOWN_SAW_OFF:<br>    action = ACTION_FLIP_B;<br>    if (switch_a) {<br>      prisoner_state[prisoner] = PRISONER_READY;<br>    }<br>    break;<br>  case PRISONER_READY:<br>    if (!switch_a) {<br>      action = ACTION_FLIP_A;<br>      prisoner_state[prisoner] = PRISONER_IDLE;<br>    } else {<br>      action = ACTION_FLIP_B;<br>    }<br>    break;<br>  case PRISONER_IDLE:<br>    action = ACTION_FLIP_B;<br>    break;<br>  }<br><br>  switch (action) {<br>    case ACTION_FLIP_A:<br>      switch_a = !switch_a;<br>      break;<br>    case ACTION_FLIP_B:<br>      switch_b = !switch_b;<br>      break;<br>    case ACTION_CALL_WARDEN:<br>      return 1;<br>    default:<br>      printf("ERROR: no action taken by prisoner #%d\n", prisoner);<br>      return -1;<br>  }<br>  return 0;<br>}<br><br>static int run_session(void) {<br>  int i;<br><br>  for (i = 0; i &lt; PRISONERS_COUNT; i++) {<br>    prisoner_state[i] = PRISONER_UNKNOWN;<br>    prisoner_visited[i] = 0;<br>  }<br>  prisoner_state[0] = MANAGER_SYNC;<br>  manager_count = 1; // always count self<br>  manager_straggler_count = 0;<br>  switch_a = abs(rand()) % 2;<br>  switch_b = abs(rand()) % 2;<br>  stats_visits = 0;<br><br>  while (1) {<br>    int r = visit_room(abs(rand()) % PRISONERS_COUNT);<br>    stats_visits++;<br>    if (1 == r) {<br>      return call_warden();<br>    }<br>    if (-1 == r) {<br>      return 1; // same as dying<br>    }<br>  }<br>}<br><br>int main(int argc, char* argv[]) {<br>  int i = 0;<br>  int visits_total = 0;<br><br>  while (i++ &lt; 5000) {<br>    printf(".");<br>    if (1 == run_session()) {<br>      printf("executed after %d visits.\n", stats_visits);<br>      break;<br>    }<br>    visits_total += stats_visits;<br>  }<br>  printf("Average visits per session: %d (%d/prisoner)\n", visits_total / i,<br>    (visits_total / i) / PRISONERS_COUNT);<br>  return 0;<br>}<br><br></pre></code>
